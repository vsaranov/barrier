# Система управления шлагбаумом

## Назначение системы

Данная система предназначена для автоматического управления шлагбаумом на въезде во двор многоквартирного дома. Система работает без участия охранника или консьержа и выполняет следующие задачи:

### Автоматический контроль доступа автомобилей

Система самостоятельно принимает решение об открытии шлагбаума на основании:

- **Входящего звонка** — позвоните на номер шлагбаума с зарегистрированного телефона, и шлагбаум откроется автоматически
- **Распознавания госномера автомобиля** — система автоматически определяет номер автомобиля с камеры видеонаблюдения и открывает шлагбаум для зарегистрированных машин

### Централизованное управление информацией о жильцах и разрешениями

Через удобный web-интерфейс администратор (представитель жильцов — старший по дому, председатель совета дома) может:

- вести базу данных с информацией о жильцах (ФИО, номер квартиры, контактные телефоны)
- регистрировать автомобили и их государственные номера
- устанавливать сроки действия разрешений (для постоянных жильцов, временных гостей, арендаторов)
- вносить информацию о сотрудниках управляющей компании, их телефонах и госномерах служебных автомобилей
- просматривать историю въездов и выездов по каждому жильцу

### Видеонаблюдение и документирование

- непрерывная видеозапись с камер
- фотофиксация каждого события с привязкой к карточке жильца
- хранение видеоархива на отдельном HDD

### Бесперебойная работа

- резервное питание обеспечивает работу системы до 2 часов при отключении электричества
- при длительном отсутствии питания шлагбаум автоматически открывается
- режим bypass — при отказе управляющего блока шлагбаум остаётся работоспособным

### Удалённое и локальное администрирование

- доступ к web-интерфейсу управления через интернет (из любой точки мира)
- локальный доступ через WiFi (для обслуживания без вскрытия шкафа, находясь рядом)

---

## Функции системы

### Для жильцов

| Функция | Как это работает |
|---------|------------------|
| **Открытие по звонку** | Позвоните на номер шлагбаума с зарегистрированного телефона — шлагбаум откроется автоматически, вызов сбросится |
| **Открытие по госномеру** | Просто подъезжайте к шлагбауму — камера распознает номер вашего автомобиля и откроет шлагбаум |
| **Автоматический выезд** | При выезде со двора шлагбаум откроется автоматически (система обнаруживает движение массивного объекта к выезду) |
| **Ночной режим** | В ночное время шлагбаум может оставаться открытым (настраивается администратором) |
| **Голосовые уведомления** | При звонке с неизвестного номера вы услышите информационное сообщение; если срок вашего разрешения скоро истекает — напоминание |

### Для администратора (представителя жильцов)

Управление системой осуществляется только представителями жильцов (старший по дому, председатель совета дома).

| Функция | Описание |
|---------|----------|
| **Ведение информации о жильцах** | Добавление, редактирование и удаление записей о жильцах через web-интерфейс |
| **Управление разрешениями** | Регистрация телефонов и госномеров, установка и продление сроков действия |
| **Данные сотрудников УК** | Возможность внесения телефонов и госномеров автомобилей сотрудников управляющей компании |
| **Журнал событий** | Просмотр всех въездов и выездов с фотографиями и временными метками |
| **Карточки жильцов** | История всех событий, связанных с конкретным жильцом или квартирой |
| **Видеоархив** | Просмотр записей с камер через web-интерфейс ZoneMinder |
| **Мониторинг системы** | Контроль состояния питания и работоспособности оборудования |

---

## Архитектура системы

Схема в работе.

### Основные компоненты

- **ПК** — центральный элемент системы, на котором работает всё программное обеспечение (Proxmox, RockyLinux, Asterisk, OpenALPR, ZoneMinder, SugarCRM). Принимает решения об открытии шлагбаума.
- **Блок датчиков и реле** — модуль на базе Arduino, подключается к ПК по USB. Управляет силовыми реле и считывает показания датчиков.
- **IP-камеры** — подключаются напрямую к ПК по сетевому кабелю (Ethernet). На компьютере не менее 3 сетевых портов. Камеры могут получать питание по PoE от блока питания системы.
- **Модем** — Quectel EC25 с поддержкой VoLTE и 2G, подключается по USB. Антенна выводится на корпус шкафа. Поддержка технологии VoLTE позволяет получать вызов из сети за минимальное время.
- **WiFi-адаптер** — работает в режиме точки доступа (AP) на частоте 2.4 ГГц. Антенна выводится на корпус шкафа.
- **Система питания** — обеспечивает бесперебойную работу ПК и возможность открытия шлагбаума при отключении электричества.

---

## Состав аппаратных средств

### Телекоммуникационный шкаф

Все компоненты системы размещаются в металлическом телекоммуникационном шкафу, который устанавливается на стене в подъезде рядом со шлагбаумом. Шкаф оборудован:

- механическим замком с комплектом ключей
- DIN-рейкой для крепления силовых модулей
- выключателем питания шлагбаума на корпусе
- выключателем освещения на корпусе (работает параллельно реле, позволяет вручную включать и отключать освещение)
- выключателем питания самого шкафа (разрыв обоих проводов питания для безопасного обслуживания оборудования)
- разъёмами для антенн 4G/2G и WiFi

### Основное оборудование

| Компонент | Назначение |
|-----------|------------|
| Компьютер (материнская плата Q1900G4-M) | Центральный блок управления, 4 порта Ethernet |
| SSD-накопитель | Системный диск 16Гб с программным обеспечением |
| HDD-накопитель | Хранение видеоархива |

### Связь

| Компонент | Назначение |
|-----------|------------|
| Модем Quectel EC25 | Приём звонков (поддержка VoLTE и 2G) |
| Антенна 4G/2G | Выносится на корпус шкафа |
| WiFi-адаптер 2.4 ГГц | Точка доступа для локального администрирования |
| Антенна WiFi | Выносится на корпус шкафа |

### Система питания

| Компонент | Назначение |
|-----------|------------|
| Блок питания 12В 10А| Питание компьютера с поддержкой резервной батареи |
| Аккумулятор 12В, 7 А/ч | Резервное питание на 2 часа |
| Инвертор 220В, 500 Вт | Преобразование 12В в 220В для питания шлагбаума при отключении сети |
| Контактор 220В | Автоматическое переключение шлагбаума и его освещения на резервное питание |

### Блок датчиков и реле

Блок функционирует на основе модулей Arduino и подключается к системе по USB. Центральным модулем является плата на базе контроллера RP2040. Модули собраны в пластиковом корпусе для монтажа на DIN-рейку:

**Реле (силовые переключатели):**
- Реле питания шлагбаума (до 600 Вт)
- Реле освещения шлагбаума (до 600 Вт)
- Реле кнопки START (имитация нажатия для открытия шлагбаума)

**Датчики:**
- Датчик тока шлагбаума — контроль работоспособности
- Датчик тока освещения — контроль работоспособности
- Датчик наличия питания 220В — фиксация отключения электричества
- Датчик работы инвертора — контроль резервного питания

### Видеонаблюдение

- без дополнительных затрат возможно подключить 3 камеры видеонаблюдения
- распознавание госномеров автомобилей с двух камер видеонаблюдения
- формат видео для захвата видеопотока и записи: H.264
- формат фото для распознавания номеров автомобилей: JPEG
- камеры могут быть запитаны от блока питания системы по технологии PoE (питание по сетевому кабелю), необходимы инжекторы

---

## Состав программных средств

Всё программное обеспечение работает на компьютере внутри шкафа. Для удобства обслуживания и быстрого восстановления используется виртуализация.

| Программа | Назначение | Пояснение для жильцов |
|-----------|------------|----------------------|
| **Proxmox VE** | Система виртуализации | Позволяет быстро восстановить работу системы в случае сбоя |
| **RockyLinux** | Операционная система | Надёжная серверная операционная система |
| **Asterisk** | Телефонная станция | Принимает звонки, воспроизводит голосовые сообщения |
| **OpenALPR** | Распознавание номеров | Определяет госномера автомобилей по видео с камеры |
| **ZoneMinder** | Видеонаблюдение | Записывает видео с камер, хранит архив, обнаруживает движение объектов, предоставляет web-интерфейс для просмотра видеоархива |
| **SugarCRM** | Ведение информации о жильцах | Web-интерфейс для ведения базы данных жильцов, их телефонов, госномеров автомобилей и просмотра журналов событий |
| **Chrony** | клиент и сервер точного времени (NTP) | Синхронизирует системное время системы с внешними источниками и одновременно раздаёт это время IP-камерам в локальной сети |

---

## Режим отказоустойчивости (Bypass)

При неработающем блоке управления система спроектирована так, чтобы не блокировать работу шлагбаума:

- **Питание шлагбаума сохраняется** — шлагбаум можно открыть с пульта или вызовом на GSM-модуль шлагбаума
- **Ручное управление освещением** — возможно последовательно соединение с датчиком освещения
- **Линия START разомкнута** — система не вмешивается в работу шлагбаума
- **Звонки переадресуются** — на SIM-карте настроена переадресация по недоступности и не ответу на номер GSM-модуля шлагбаума.

---

## Журналирование событий

Система ведёт подробный журнал всех событий:

| Событие | Что фиксируется |
|---------|-----------------|
| Отключение/включение питания 220В | Время, продолжительность |
| Запуск системы | Время старта после перезагрузки |
| Входящий звонок | Номер телефона, результат авторизации, фото с камеры |
| Распознавание госномера | Номер автомобиля, результат авторизации, фото |
| Выезд автомобиля | Обнаружение движения массивного объекта системой ZoneMinder, фото с камеры выезда |

Все события, которые можно связать с конкретным жильцом, автоматически прикрепляются к его карточке в системе.

---

## Подключения к шкафу

К телекоммуникационному шкафу подводятся:

- **Питание 220В** — от электрощита подъезда
- **Интернет (Ethernet)** — от домового маршрутизатора (опционально)
- **Кабели к шлагбауму:**
  - Питание шлагбаума 220В
  - Питание освещения 220В
  - Линия START (2 провода для открытия шлагбаума)

---

## Доступ к системе

### Через интернет

Система получает IP-адрес от домового маршрутизатора. Доступ из интернета возможен через:
- Сервис динамических DNS (например, DynDNS)
- Выделенное доменное имя с публичным IP-адресом

### Локально через WiFi

Находясь рядом со шкафом, можно подключиться к встроенной точке доступа WiFi и получить доступ к web-интерфейсу управления. Это удобно для обслуживания без вскрытия шкафа.

### Важно

Отсутствие интернета не влияет на основные функции системы — открытие по звонку и распознавание номеров продолжат работать.

---

## Размещение оборудования

Телекоммуникационный шкаф размещается на стене в одном из подъездов дома, в непосредственной близости к шлагбауму. Это обеспечивает:

- Минимальную длину кабелей до шлагбаума
- Удобный доступ для обслуживания
- Защиту оборудования от погодных условий, температуру окружающей среды более 0 градусов.

---

## Обслуживание системы

Обслуживание системы планируется выполнять силами технических специалистов из числа жильцов дома при необходимости.

Система спроектирована с учётом простоты обслуживания:

- **Открытое ПО** — используются готовые проекты, мы только конфигурируем его, интегрируем между собой
- **Удалённая диагностика** — доступ к системе через интернет или локально через WiFi
- **Виртуализация** — позволяет быстро восстановить работу системы, эмулирует KVM
- **Резервный SSD** — содержит актуальную копию системы на случай выхода из строя основного накопителя
- **Модульная конструкция** — компоненты на DIN-рейке легко заменяются
- **Точка доступа WiFi** — позволяет администрировать систему без вскрытия шкафа, находясь рядом

При возникновении неисправностей система продолжает работать в режиме bypass, обеспечивая базовое управление шлагбаумом до устранения проблемы.
